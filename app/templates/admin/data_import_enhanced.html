{% extends "base.html" %}
{% block title %}Data Import - YatriSetu Admin{% endblock %}

{% block content %}
{% set active_page = 'data_import' %}
{% include 'admin/_sidebar.html' %}

<div class="main-content">
    <div class="content-header">
        <h1><i class="fas fa-file-import"></i> Data Import</h1>
        <p>Import and preview buses, routes, fares, and stops data with duplicate detection</p>
    </div>

    <!-- Step Indicator -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="steps">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-label">Upload File</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-label">Preview & Edit</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-label">Import to Database</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="card mb-4" id="uploadSection">
        <div class="card-header">
            <h5><i class="fas fa-upload"></i> Step 1: Upload File</h5>
        </div>
        <div class="card-body">
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                <h5>Drag and drop file here or click to browse</h5>
                <p class="text-muted">Supported formats: CSV, PDF (Max size: 10MB)</p>
                <input type="file" id="fileInput" accept=".csv,.pdf" style="display: none;">
                <button class="btn btn-primary mt-3" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-folder-open"></i> Browse Files
                </button>
            </div>
            
            <div id="fileInfo" class="mt-3" style="display: none;">
                <div class="alert alert-info">
                    <strong>Selected File:</strong> <span id="fileName"></span>
                    <button class="btn btn-sm btn-danger float-end" onclick="clearFile()">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
                
                <div class="mt-3">
                    <label for="categorySelect" class="form-label">Select Data Category:</label>
                    <select class="form-select" id="categorySelect">
                        <option value="">-- Auto Detect --</option>
                        <option value="buses">Buses</option>
                        <option value="routes">Routes</option>
                        <option value="fares">Fares</option>
                        <option value="stops">Stops</option>
                    </select>
                </div>
                
                <button class="btn btn-success mt-3" onclick="analyzeAndPreview()">
                    <i class="fas fa-eye"></i> Analyze & Preview Data
                </button>
            </div>
        </div>
    </div>

    <!-- Preview Section -->
    <div class="card mb-4" id="previewSection" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-table"></i> Step 2: Preview & Edit Data</h5>
            <div>
                <span class="badge bg-primary" id="totalRecordsBadge">0 records</span>
                <span class="badge bg-warning" id="duplicatesBadge">0 duplicates</span>
                <span class="badge bg-danger" id="errorsBadge">0 errors</span>
            </div>
        </div>
        <div class="card-body">
            <!-- Summary Stats -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-label">Total Records</div>
                        <div class="stat-value" id="totalRecords">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-label">To Insert</div>
                        <div class="stat-value text-success" id="toInsert">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-label">Duplicates</div>
                        <div class="stat-value text-warning" id="duplicateCount">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box">
                        <div class="stat-label">Errors</div>
                        <div class="stat-value text-danger" id="errorCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Filter Options -->
            <div class="mb-3">
                <button class="btn btn-sm btn-outline-primary" onclick="filterPreview('all')">
                    <i class="fas fa-list"></i> All
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="filterPreview('insert')">
                    <i class="fas fa-plus"></i> To Insert
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="filterPreview('duplicate')">
                    <i class="fas fa-copy"></i> Duplicates
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="filterPreview('error')">
                    <i class="fas fa-exclamation-triangle"></i> Errors
                </button>
            </div>

            <!-- Data Table -->
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-striped table-hover" id="previewTable">
                    <thead class="sticky-top bg-light">
                        <tr id="previewTableHeader">
                            <th width="50">#</th>
                            <th width="100">Action</th>
                            <th width="100">Status</th>
                            <!-- Dynamic columns will be added here -->
                        </tr>
                    </thead>
                    <tbody id="previewTableBody">
                        <!-- Data rows will be added here -->
                    </tbody>
                </table>
            </div>

            <!-- Action Buttons -->
            <div class="mt-3 d-flex justify-content-between">
                <button class="btn btn-secondary" onclick="backToUpload()">
                    <i class="fas fa-arrow-left"></i> Back to Upload
                </button>
                <button class="btn btn-success" onclick="proceedToImport()">
                    <i class="fas fa-database"></i> Proceed to Import
                </button>
            </div>
        </div>
    </div>

    <!-- Import Confirmation Section -->
    <div class="card mb-4" id="importSection" style="display: none;">
        <div class="card-header">
            <h5><i class="fas fa-database"></i> Step 3: Import to Database</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle"></i> Import Summary</h6>
                <p>You are about to import the following data:</p>
                <ul>
                    <li><strong>Records to Insert:</strong> <span id="finalInsertCount">0</span></li>
                    <li><strong>Records to Update:</strong> <span id="finalUpdateCount">0</span></li>
                    <li><strong>Records to Skip:</strong> <span id="finalSkipCount">0</span></li>
                </ul>
            </div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="confirmImport">
                <label class="form-check-label" for="confirmImport">
                    I confirm that I have reviewed the data and want to proceed with the import
                </label>
            </div>

            <div class="d-flex justify-content-between">
                <button class="btn btn-secondary" onclick="backToPreview()">
                    <i class="fas fa-arrow-left"></i> Back to Preview
                </button>
                <button class="btn btn-success" onclick="executeImport()" id="importButton" disabled>
                    <i class="fas fa-check"></i> Execute Import
                </button>
            </div>

            <!-- Import Progress -->
            <div id="importProgress" class="mt-3" style="display: none;">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
                        Importing data...
                    </div>
                </div>
            </div>

            <!-- Import Results -->
            <div id="importResults" class="mt-3" style="display: none;"></div>
        </div>
    </div>
</div>

<style>
.steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    left: 50%;
    width: 100%;
    height: 2px;
    background: #dee2e6;
    z-index: -1;
}

.step.active .step-number {
    background: #0d6efd;
    color: white;
}

.step.completed .step-number {
    background: #198754;
    color: white;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 8px;
}

.step-label {
    font-size: 14px;
    color: #6c757d;
}

.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.upload-area:hover {
    border-color: #0d6efd;
    background: #f8f9fa;
}

.stat-box {
    padding: 15px;
    border-radius: 8px;
    background: #f8f9fa;
    text-align: center;
}

.stat-label {
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 5px;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #212529;
}

.row-duplicate {
    background-color: #fff3cd !important;
}

.row-error {
    background-color: #f8d7da !important;
}

.row-insert {
    background-color: #d1e7dd !important;
}

.editable-cell {
    cursor: pointer;
    position: relative;
}

.editable-cell:hover {
    background-color: #e9ecef;
}
</style>

<script src="{{ url_for('static', filename='js/data-import-enhanced.js') }}"></script>
{% endblock %}
